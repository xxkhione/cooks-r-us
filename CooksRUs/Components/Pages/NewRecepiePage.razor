@page "/upload"
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer

<PageTitle>Upload</PageTitle>

@if(userID == -1)
{
    <div class="PromptUserSignIn">

        <p>It seems you are't signed in...</p>
        <a href="/SignIn">Sign in or make an account here!</a>

    </div>
}
else
{
    <header>
        <h1>Share Your Recipe! 🌎</h1>
    </header>

    <div class="CREATING-A-RECEPIE">

        <input type="text" @bind-value="newRecepie.recepie_name" placeholder="Recepie Name" />
        <br />

        @foreach (ingredient i in ing_list)
        {
            <IngredientComponent ing="i"
                                 OnDelete="DeleteIngredient"
                                 currentRecepie="newRecepie"></IngredientComponent>
            <br />
        }
        <br />
        <button @onclick="AddIngredient">Add Ingredient</button>
        <br />
        <input type="text" @bind-value="newRecepie.directions" placeholder="Recepie Directions" />
        <br />
        <button @onclick="SubmitRecepie">Submit Recepie</button>
    </div>
}


@code {
    int userID;

    private List<ingredient> ing_list = new List<ingredient>();
    private recepie newRecepie;
    private ingredient_list newIngLst;

    protected override async Task OnInitializedAsync()
    {
        userID = await GetUserID();
        newRecepie = new recepie
            {
                recepie_name = "",
                directions = "",
                image = null,
                creatorid = userID
            };

        newIngLst = new ingredient_list
        {
            recepie_id = newRecepie.id
        };
        AddIngredient();
    }

    private void AddIngredient()
    {
        ing_list.Add(new ingredient { list_id = newIngLst.id, ingredient_name = "", amount = "" });
    }

    private void DeleteIngredient(ingredient ingre)
    {
        ing_list.Remove(ingre);
    }

    private async Task<int> GetUserID()
    {
        try
        {
            return await cookie.GetValue();
        }
        catch
        {
            //User not signed in, show an error msg
            return -1;
        }
    }

    private async Task SubmitRecepie()
    {
        try
        {
            // Link entities via navigation properties so EF will set FKs on save
            newIngLst.recepie = newRecepie;
            newIngLst.ingredients = ing_list;

            foreach (var ing in ing_list)
            {
                ing.list = newIngLst;
            }

            // Add root/aggregate to the context — EF will insert related entities
            dbContext.Add(newRecepie);
            dbContext.Add(newIngLst);

            await dbContext.SaveChangesAsync();
            navigation.NavigateTo("/", true);

            
        }
        catch (Exception e)
        {
            Console.WriteLine("ERROR:");
            Console.WriteLine(e);
        }
    }
}
