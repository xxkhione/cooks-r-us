@using CooksRUs.Shared
@using CooksRUs.Entities
@using Microsoft.EntityFrameworkCore
@inject CooksRUs.Database.CooksRUsDbContext dbContext
@inject CooksRUs.Components.Cookie.ICookie cookie

@page "/search"

<PageTitle>Search</PageTitle>

<header>
    <h1>🔍 Search Recipes</h1>
</header>

<input id="search-bar" class="search-input" @bind="query" placeholder="Search recipes..."/>
<button type="button" id="search-btn" @onclick="SearchRecipes">Search 😋</button>

@if(SearchResults.Count == 0)
{
    <p>No results yet — try searching something!</p>
}
else
{
    <div class="container">
        @foreach(var r in SearchResults)
        {
            var recep = r;

            <RecipeCard Title="@r.recepie_name" Description="@r.directions" Creator="@r.creator" ImageURL="@r.image"
                        ShowSaveButton="userIsSignedIn" rec="r" />
        }
    </div>
}

@code {

    string query = "";
    List<recepie> SearchResults = new();
    bool userIsSignedIn;

    async Task SearchRecipes()
    {
        try
        {
            SearchResults = await dbContext.recepies
                .Include(r => r.creator)          // ensure creator populated
                .Where(r => r.recepie_name.Contains(query))
                .ToListAsync();
        }
        catch
        {
            SearchResults = new();
        }

    }

    protected override void OnInitialized()
    {
        //only show the save button if the user is signed in
        try
        {
            userIsSignedIn = cookie.GetValue().Result > 0;
        }
        catch
        {
            userIsSignedIn = false;
        }
    }
}
