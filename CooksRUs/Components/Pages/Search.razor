@using CooksRUs.Shared
@using CooksRUs.Entities
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<CooksRUs.Database.CooksRUsDbContext> DbFactory
@inject CooksRUs.Components.Cookie.ICookie cookie
@inject IHttpClientFactory ClientFactory


@page "/search"
@using CooksRUs.Models
@inject IHttpClientFactory ClientFactory

<PageTitle>Search</PageTitle>



<header>
   
    <h1>🔍 Look For Recipes Here!</h1>        
    <div class="search-wrapper">
        <input type="text" id="search-bar" class="search-input" placeholder="Search for a recipe..." />
        <button class="search-button" id="search-btn">Search 😋</button>
    </div>

</header>
<main class="container">
    @if (Recipes is null)
    {
        <p>Type a keyword to search for recipes.</p>
    }
    else if (Recipes.Count == 0)
    {
        <p>No recipes found.</p>
    }
    else
    {
        @foreach (var recipe in Recipes)
@if (SearchResults.Count == 0)
{
    <p>No results yet — try searching something!</p>
}
else
{
    <div class="container">
        @foreach (var r in SearchResults)
        {
            <RecipeCard Title="@r.recepie_name"
                        Description="@r.directions"
                        Creator="@r.creator"
                        ImageURL="@r.image"
                        ShowSaveButton="userIsSignedIn"
                        isUserCreator="@CheckCreator(r)"
                        rec="r" />
        }
    </div>
}

@code {

    string query = "";
    List<recepie> SearchResults = new();
    bool userIsSignedIn = false;
    private string SearchText { get; set; } = string.Empty;
    private List<Recipe>? Recipes { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // Check if user is signed in
        try
        {
            var userId = await cookie.GetValue();
            userIsSignedIn = userId > 0;
        }
        catch
        {
            userIsSignedIn = false;
        }

    private async Task SearchAsync()
    {
        if (string.IsNullOrWhiteSpace(SearchText))
        {
                Recipes = new List<Recipe>();
            return;
        }

        var client = ClientFactory.CreateClient("BackendApi");
        Recipes = await client.GetFromJsonAsync<List<Recipe>>($"api/recipes?searchQuery={Uri.EscapeDataString(SearchText)}");


    }



    async Task SearchRecipes()
    {
        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();

            SearchResults = await dbContext.recepies
                .Include(r => r.creator)          // ensure creator populated
                .Where(r => r.recepie_name.Contains(query))
                .ToListAsync();

    void SaveRecipe(recepie r){
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching recipes: {ex.Message}");
            SearchResults = new();
        }
    }
    bool CheckCreator(recepie r)
    {
        // ensure the crator controls aren't carried over from previous search
        return r.creatorid == cookie.GetValue().Result ? true : false; 
    {
        // ensure the crator controls aren't carried over from previous search
        return r.creatorid == cookie.GetValue().Result ? true : false; 
    }
}

    public class Recipe { public string? Title; public string? Description; public string? ImageUrl; }
}
