@using CooksRUs.Shared
@using CooksRUs.Entities
@using Microsoft.EntityFrameworkCore
@inject CooksRUs.Database.CooksRUsDbContext dbContext
@inject CooksRUs.Components.Cookie.ICookie cookie

@page "/search"

<PageTitle>Search</PageTitle>

<header>
    <h1>🔍 Search Recipes</h1>
</header>

<input id="search-bar" class="search-input" @bind="query" placeholder="Search recipes..."/>
<button type="button" id="search-btn" @onclick="SearchRecipes">Search 😋</button>

@if(SearchResults.Count == 0)
{
    <p>No results yet — try searching something!</p>
}
else
{
    <div class="container">
        @foreach(var r in SearchResults)
        {

            <RecipeCard Title="@r.recepie_name" Description="@r.directions" Creator="@r.creator" ImageURL="@r.image"
                        ShowSaveButton="userIsSignedIn" OnSave="@(async () => await SaveRecipe(r))" />
        }
    </div>
}

@code {

    string query = "";
    List<recepie> SearchResults = new();
    bool userIsSignedIn;

    async Task SearchRecipes()
    {
        try
        {
            SearchResults = await dbContext.recepies
                .Include(r => r.creator)          // ensure creator populated
                .Where(r => r.recepie_name.Contains(query))
                .ToListAsync();
        }
        catch
        {
            SearchResults = new();
        }

    }

    //Method not being called for some reason!!

    async Task SaveRecipe(recepie r)
    {
        Console.WriteLine("Save Ran");

        try
        {
            var userID = await cookie.GetValue();

            // avoid duplicate faves
            var exists = await dbContext.faved_recepies
                .AnyAsync(fr => fr.user_id == userID && fr.recepie_id == r.id);

            if (exists)
            {
                return;
            }

            dbContext.faved_recepies.Add(new faved_recepie
            {
                user_id = userID,
                recepie_id = r.id
            });

            await dbContext.SaveChangesAsync();
        }
        catch (Exception)
        {
            //an error happened
        }
    }

    protected override void OnInitialized()
    {
        //only show the save button if the user is signed in
        try
        {
            userIsSignedIn = cookie.GetValue().Result > 0;
        }
        catch
        {
            userIsSignedIn = false;
        }
    }
}
