@using CooksRUs.Shared
@using CooksRUs.Entities
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<CooksRUs.Database.CooksRUsDbContext> DbFactory
@inject CooksRUs.Components.Cookie.ICookie cookie

@page "/search"

<PageTitle>Search</PageTitle>

<header>
    <h1>🔍 Search Recipes</h1>
</header>

<input id="search-bar" class="search-input" @bind="query" placeholder="Search recipes..." />
<button type="button" id="search-btn" @onclick="SearchRecipes">Search 😋</button>

@if (SearchResults.Count == 0)
{
    <p>No results yet — try searching something!</p>
}
else
{
    <div class="container">
        @foreach (var r in SearchResults)
        {
            <RecipeCard Title="@r.recepie_name"
                        Description="@r.directions"
                        Creator="@r.creator"
                        ImageURL="@r.image"
                        ShowSaveButton="userIsSignedIn"
                        isUserCreator="@CheckCreator(r)"
                        rec="r" />
        }
    </div>
}

@code {

    string query = "";
    List<recepie> SearchResults = new();
    bool userIsSignedIn = false;

    protected override async Task OnInitializedAsync()
    {
        // Check if user is signed in
        try
        {
            var userId = await cookie.GetValue();
            userIsSignedIn = userId > 0;
        }
        catch
        {
            userIsSignedIn = false;
        }
    }

    async Task SearchRecipes()
    {
        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();

            SearchResults = await dbContext.recepies
                .Include(r => r.creator)          // ensure creator populated
                .Where(r => r.recepie_name.Contains(query))
                .ToListAsync();


        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching recipes: {ex.Message}");
            SearchResults = new();
        }
    }
    bool CheckCreator(recepie r)
    {
        // ensure the crator controls aren't carried over from previous search
        return r.creatorid == cookie.GetValue().Result ? true : false; 
    }
}