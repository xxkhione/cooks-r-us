@using CooksRUs.Shared
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<CooksRUs.Database.CooksRUsDbContext> DbFactory
@inject CooksRUs.Components.Cookie.ICookie cookie

@page "/"

<PageTitle>Home</PageTitle>

<header>
    <h1>Welcome to Cooks R Us! 🧑‍🍳</h1>
    <p>Browse, save, upload — recipes for everyone.</p>
</header>

<h2>Your Saved Recipes ⭐</h2>

@if (userID == -1)
{
    <div class="PromptUserSignIn">
        <p>It seems you aren't signed in...</p>
        <a href="/SignIn">Sign in or make an account here!</a>
    </div>
}
else
{
    @if (savedRecipes.Count == 0)
    {
        <p>You haven't saved anything yet — go explore!</p>
    }
    else
    {
        <div class="container">
            @foreach (var r in savedRecipes)
            {
                <RecipeCard Title="@r.recepie_name"
                            Description="@r.directions"
                            Creator="@r.creator"
                            ImageURL="@r.image"
                            ShowSaveButton="userIsSignedIn"
                            rec="r" />
            }
        </div>
    }
}

@code {
    int userID = -1;
    bool userIsSignedIn = false;
    List<recepie> savedRecipes = new();

    protected override async Task OnInitializedAsync()
    {
        userID = await GetUserID();
        if (userID > 0)
        {
            await GetSavedRecepies();
            userIsSignedIn = true;
        }
    }

    private async Task GetSavedRecepies()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();

        // Query the faved_recepies table and include the creator relationship
        savedRecipes = await dbContext.faved_recepies
            .Where(fr => fr.user_id == userID)
            .Include(fr => fr.recepie)
                .ThenInclude(r => r.creator)  // Explicitly include the creator
            .Select(fr => fr.recepie)
            .ToListAsync();
    }

    private async Task<int> GetUserID()
    {
        try
        {
            return await cookie.GetValue();
        }
        catch
        {
            // User not signed in
            return -1;
        }
    }

    async Task SaveRecipe(recepie r)
    {
        Console.WriteLine("Save Ran");

        try
        {
            var userID = await cookie.GetValue();

            await using var dbContext = await DbFactory.CreateDbContextAsync();

            // avoid duplicate faves
            var exists = await dbContext.faved_recepies
                .AnyAsync(fr => fr.user_id == userID && fr.recepie_id == r.id);

            if (exists)
            {
                return;
            }

            dbContext.faved_recepies.Add(new faved_recepie
            {
                user_id = userID,
                recepie_id = r.id
            });

            await dbContext.SaveChangesAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving recipe: {ex.Message}");
        }
    }
}