@using CooksRUs.Shared
@using Microsoft.EntityFrameworkCore
@inject CooksRUs.Database.CooksRUsDbContext dbContext

@page "/"

<PageTitle>Home</PageTitle>

<header>
    <h1>Welcome to Cooks R Us! 🧑‍🍳</h1>
    <p>Browse, save, upload — recipes for everyone.</p>
</header>

<h2>Your Saved Recipes ⭐</h2>

@if (userID == -1)
{
    <div class="PromptUserSignIn">

        <p>It seems you are't signed in...</p>
        <a href="/SignIn">Sign in or make an account here!</a>

    </div>
}
else
{
    

    @if (savedRecipes.Count == 0)
    {
        <p>You haven't saved anything yet — go explore!</p>
    }
    else

    {
        <div class="container">
            @foreach (var recipe in savedRecipes)
            {
                <RecipeCard Title="@recipe.recepie_name" Description="@recipe.directions" Creator="@recipe.creator" ImageURL="@recipe.image"
                ShowEditControls="false" ShowSaveButton="false" />
            }
        </div>
    }

}
@code {
    int userID;

    List<recepie> savedRecipes = new();          // backend will fill these
    List<recepie> featuredRecipes = new();       // showcase random recipes

    protected override async Task OnInitializedAsync()
    {
        userID = await GetUserID();
        if (userID != -1)
        {
            await GetSavedRecepies();
        }
    }

    private async Task GetSavedRecepies()
    {
        // Query the faved_recepies table and select the related recepie entity.
        savedRecipes = await dbContext.faved_recepies
            .Where(fr => fr.user_id == userID)
            .Select(fr => fr.recepie)
            .ToListAsync();
    }

    void SaveRecipe(recepie r){
        savedRecipes.Add(r); // backend integration later
    }

    private async Task<int> GetUserID()
    {
        try
        {
            return await cookie.GetValue();
        }
        catch
        {
            //User not signed in, show an error msg
            return -1;
        }
    }
}
