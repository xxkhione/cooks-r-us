@using CooksRUs.Entities
@using Microsoft.EntityFrameworkCore
@inject CooksRUs.Database.CooksRUsDbContext dbContext
@inject CooksRUs.Components.Cookie.ICookie cookie

<div class="recipe-card">
    <img src="@ImageURL" class="recipe-img" />

    <h2>@Title</h2>
    <p>@(Description?.Length > 120 ? Description.Substring(0, 120) + "..." : Description)</p>
    @if(Creator != null)
    {
        <p><small>Creator: @Creator.username</small></p>
    }
    else
    {
        // this should never happen
        // but just incase it does
        <p><small>Creator: Unknown</small></p>
    }

    @if (ShowSaveButton)
    {
        <button type="button" class="card-btn save-btn" onclick="@SaveRecipe(rec)">Save ❤️</button>
    }

    @if (CheckCreator())
    {
        <div class="card-controls">
            <button type="button" class="card-btn edit-btn" onclick="OnEdit">Edit ✏️</button>
            <button type="button" class="card-btn delete-btn" onclick="@OnDelete">Delete 🗑️</button>
        </div>
    }
</div>

@code {
    [Parameter] public string? Title { get; set; }
    [Parameter] public string? Description { get; set; }
    [Parameter] public user? Creator { get; set; }
    [Parameter] public byte[]? ImageURL { get; set; }

    [Parameter] public recepie? rec { get; set; }

    [Parameter] public bool ShowSaveButton { get; set; }

    [Parameter] public EventCallback OnSave { get; set; }
    [Parameter] public EventCallback OnEdit { get; set; }

    public void OnDelete()
    {
        Console.WriteLine("On Delete clicked for this recepie: " + Title);

    }

    //Check to see if the user signed in is the creator
    // for edit perms.
    private bool CheckCreator()
    {
        try
        {
            if (Creator != null && Creator.id == cookie.GetValue().Result)
            {
                return true;
            }
            else
            {
                return false;
            }

        }
        catch
        {
            return false;
        }
    }

    async Task SaveRecipe(recepie r)
    {
        Console.WriteLine("Save Ran");

        try
        {
            var userID = await cookie.GetValue();

            // avoid duplicate faves
            var exists = await dbContext.faved_recepies
                .AnyAsync(fr => fr.user_id == userID && fr.recepie_id == r.id);

            if (exists)
            {
                return;
            }

            dbContext.faved_recepies.Add(new faved_recepie
            {
                user_id = userID,
                recepie_id = r.id
            });

            await dbContext.SaveChangesAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Err in Save: {ex.Message}");
        }
    }

    private async Task HandleSaveClick()
    {
        await OnSave.InvokeAsync();
    }


}
